<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{TITLE}}</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
{{HEADER}}
<div class='container'>
  <h2>Device Dashboard</h2>
  <div class='water-tank-section'>
    <h3>Real-Time Water Level</h3>
    <div id='volume-unit-select' style='display:none; margin-bottom:10px;'>
      <label for='unit-dropdown'>Volume unit:</label>
      <select id='unit-dropdown'>
        <option value='L'>Liters (L)</option>
        <option value='gal'>Gallons (gal)</option>
      </select>
    </div>
    <div class='tank-visual'>
      <div id='rect-tank-svg' style='{{RECT_STYLE}}'>
        <svg width='320' height='220' viewBox='0 0 320 220'>
          <!-- 3D Tank: front, top, side -->
          <!-- Top face -->
          <polygon points='60,40 200,40 240,70 100,70' fill='#b3e5fc' stroke='#0288d1' stroke-width='2'/>
          <!-- Left face -->
          <polygon points='60,40 60,160 100,190 100,70' fill='#e0e0e0' stroke='#0288d1' stroke-width='2'/>
          <!-- Right face -->
          <polygon points='200,40 200,160 240,190 240,70' fill='#bdbdbd' stroke='#0288d1' stroke-width='2'/>
          <!-- Front face (water background) -->
          <polygon id='water-bg' points='100,70 240,70 240,190 100,190' fill='#e0f7fa' stroke='#0288d1' stroke-width='2'/>
          <!-- Water fill (animated) -->
          <polygon id='water-fill-3d' points='100,190 240,190 240,190 100,190' fill='#29b6f6' opacity='0.7'/>
          <!-- Tank outline (front) -->
          <polygon points='100,70 240,70 240,190 100,190' fill='none' stroke='#0288d1' stroke-width='3'/>
          <!-- Height dimension (left) -->
          <line x1='50' y1='70' x2='50' y2='190' stroke='#333' marker-start='url(#arrow)' marker-end='url(#arrow)'/>
          <text x='35' y='130' font-size='12' fill='#333' transform='rotate(-90 35,130)'>{{TANK_DEPTH}} cm</text>
          <!-- Width dimension (bottom) -->
          <line x1='100' y1='200' x2='240' y2='200' stroke='#333' marker-start='url(#arrow)' marker-end='url(#arrow)'/>
          <text x='170' y='215' font-size='12' fill='#333' text-anchor='middle'>{{TANK_WIDTH}} cm</text>
          <!-- Length dimension (top, dashed) -->
          <line x1='60' y1='35' x2='200' y2='35' stroke='#333' stroke-dasharray='4' marker-start='url(#arrow)' marker-end='url(#arrow)'/>
          <text x='130' y='25' font-size='12' fill='#333' text-anchor='middle'>{{TANK_LENGTH}} cm</text>
          <!-- Water level text overlay -->
          <text id='rect-water-label' x='170' y='150' font-size='22' fill='#01579b' text-anchor='middle' alignment-baseline='middle' font-weight='bold'></text>
          <!-- Arrowhead marker definition -->
          <defs>
            <marker id='arrow' markerWidth='6' markerHeight='6' refX='3' refY='3' orient='auto' markerUnits='strokeWidth'>
              <path d='M0,0 L6,3 L0,6 L2,3 z' fill='#333'/>
            </marker>
          </defs>
        </svg>
      </div>
      <div id='cyl-tank-svg' style='{{CYL_STYLE}}'>
        <svg width='220' height='260' viewBox='0 0 220 260'>
          <!-- Tank body (side walls) -->
          <rect x='60' y='40' width='100' height='160' fill='#e0e0e0' stroke='#0288d1' stroke-width='2'/>
          <!-- Top ellipse (tank opening) -->
          <ellipse cx='110' cy='40' rx='50' ry='20' fill='#b3e5fc' stroke='#0288d1' stroke-width='2'/>
          <!-- Bottom ellipse (tank base) -->
          <ellipse cx='110' cy='200' rx='50' ry='20' fill='#b3e5fc' stroke='#0288d1' stroke-width='2'/>
          <!-- Water fill (animated) -->
          <g id='cyl-water-group'>
            <rect id='cyl-water-rect' x='60' y='200' width='100' height='0' fill='#29b6f6' opacity='0.7'/>
            <ellipse id='cyl-water-ellipse' cx='110' cy='200' rx='50' ry='20' fill='#29b6f6' opacity='0.7'/>
          </g>
          <!-- Tank outline (front) -->
          <rect x='60' y='40' width='100' height='160' fill='none' stroke='#0288d1' stroke-width='3'/>
          <!-- Height dimension (left) -->
          <line x1='40' y1='40' x2='40' y2='200' stroke='#333' marker-start='url(#arrow)' marker-end='url(#arrow)'/>
          <text x='25' y='130' font-size='12' fill='#333' transform='rotate(-90 25,130)'>{{TANK_DEPTH}} cm</text>
          <!-- Diameter dimension (bottom) -->
          <line x1='60' y1='230' x2='160' y2='230' stroke='#333' marker-start='url(#arrow)' marker-end='url(#arrow)'/>
          <text x='110' y='245' font-size='12' fill='#333' text-anchor='middle'>{{TANK_DIAMETER}} cm</text>
          <!-- Water level text overlay -->
          <text id='cyl-water-label' x='110' y='140' font-size='22' fill='#01579b' text-anchor='middle' alignment-baseline='middle' font-weight='bold'></text>
          <!-- Arrowhead marker definition -->
          <defs>
            <marker id='arrow' markerWidth='6' markerHeight='6' refX='3' refY='3' orient='auto' markerUnits='strokeWidth'>
              <path d='M0,0 L6,3 L0,6 L2,3 z' fill='#333'/>
            </marker>
          </defs>
        </svg>
      </div>
    </div>
  </div>
  <div class='dashboard-grid'>
    <a href='/settings/wifi' class='dashboard-widget'>
      <span class='widget-icon'>&#128279;</span>
      <span class='widget-label'>WiFi</span>
    </a>
    <a href='/settings/mqtt' class='dashboard-widget'>
      <span class='widget-icon'>&#9729;</span>
      <span class='widget-label'>MQTT</span>
    </a>
    <a href='/settings/tank' class='dashboard-widget'>
      <span class='widget-icon'>&#128738;</span>
      <span class='widget-label'>Tank</span>
    </a>
    <a href='/settings/sensor' class='dashboard-widget'>
      <span class='widget-icon'>&#128246;</span>
      <span class='widget-label'>Sensor</span>
    </a>
    <a href='/settings/display' class='dashboard-widget'>
      <span class='widget-icon'>&#128161;</span>
      <span class='widget-label'>Display</span>
    </a>
    <a href='/settings/network' class='dashboard-widget'>
      <span class='widget-icon'>&#127760;</span>
      <span class='widget-label'>Network</span>
    </a>
    <a href='/settings/alerts' class='dashboard-widget'>
      <span class='widget-icon'>&#128276;</span>
      <span class='widget-label'>Alerts</span>
    </a>
    <a href='/settings/device' class='dashboard-widget'>
      <span class='widget-icon'>&#9881;</span>
      <span class='widget-label'>Device</span>
    </a>
    <a href='/logs' class='dashboard-widget'>
      <span class='widget-icon'>&#128221;</span>
      <span class='widget-label'>Logs</span>
    </a>
    <a href='/help' class='dashboard-widget'>
      <span class='widget-icon'>&#10067;</span>
      <span class='widget-label'>Help</span>
    </a>
  </div>
</div>
<script>
let currentLevel = 0;
let tankShape = '{{TANK_SHAPE}}';
let displayMode = '{{DISPLAY_MODE}}';
let volumeUnit = 'L';
function fetchVolumeUnit() {
  fetch('/api/volumeunit').then(r => r.json()).then(data => {
    if (data && data.unit) {
      volumeUnit = data.unit;
      updateVolumeUnitDropdown();
      pollLevel();
    }
  });
}
function updateVolumeUnitDropdown() {
  const select = document.getElementById('unit-dropdown');
  if (!select) return;
  select.value = volumeUnit;
}
function handleVolumeUnitChange() {
  const select = document.getElementById('unit-dropdown');
  if (!select) return;
  select.addEventListener('change', function() {
    volumeUnit = select.value;
    fetch('/api/volumeunit', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ unit: volumeUnit })
    }).then(() => pollLevel());
  });
}
function showOrHideVolumeUnit() {
  const unitDiv = document.getElementById('volume-unit-select');
  if (!unitDiv) return;
  unitDiv.style.display = (displayMode === 'volume') ? '' : 'none';
}
window.addEventListener('DOMContentLoaded', function() {
  fetchVolumeUnit();
  handleVolumeUnitChange();
  showOrHideVolumeUnit();
});
function animateTank(target, label) {
  const fill = document.getElementById('water-fill');
  const text = document.getElementById('level-text');
  let displayed = currentLevel;
  function step() {
    displayed += (target - displayed) * 0.15;
    if (Math.abs(displayed - target) < 0.2) displayed = target;
    let h = Math.max(0, Math.min(200, 2 * displayed));
    fill.setAttribute('y', 220 - h);
    fill.setAttribute('height', h);
    if (label !== undefined) text.textContent = label;
    if (displayed !== target) requestAnimationFrame(step);
    else currentLevel = target;
  }
  step();
}
function updateTankSVG() {
  var shape = '{{TANK_SHAPE}}';
  document.getElementById('rect-tank-svg').style.display = (shape === 'rectangle') ? '' : 'none';
  document.getElementById('cyl-tank-svg').style.display = (shape === 'cylinder') ? '' : '';
}
window.addEventListener('DOMContentLoaded', updateTankSVG);
// Animate rectangular tank water fill (2D fallback)
function animateRectTank(percent) {
  var fill = document.getElementById('rect-water-fill');
  if (!fill) return;
  var maxH = 120;
  var h = Math.max(0, Math.min(maxH, maxH * percent / 100));
  fill.setAttribute('y', 140 - h);
  fill.setAttribute('height', h);
}
// Animate 3D rectangular tank water fill
function animateRectTank3D(percent) {
  var fill = document.getElementById('water-fill-3d');
  if (!fill) return;
  var maxY = 190, minY = 70;
  var y = maxY - (maxY - minY) * (percent / 100);
  // Animate the water polygon
  fill.setAttribute('points', `100,190 240,190 240,${y} 100,${y}`);
}
function animateCylTank3D(percent) {
  var rect = document.getElementById('cyl-water-rect');
  var ellipse = document.getElementById('cyl-water-ellipse');
  if (!rect || !ellipse) return;
  var maxH = 160, minY = 40, maxY = 200;
  var h = Math.max(0, Math.min(maxH, maxH * percent / 100));
  var y = maxY - h;
  rect.setAttribute('y', y);
  rect.setAttribute('height', h);
  ellipse.setAttribute('cy', y);
}
function pollLevel() {
  fetch('/api/level').then(r => r.json()).then(data => {
    let configUnit = '{{OUTPUT_UNIT}}';
    let tankDepth = parseFloat('{{TANK_DEPTH}}');
    let distance = parseFloat('{{DISTANCE}}');
    let percent = data.level;
    let label = '';
    if (displayMode === 'volume') {
      let level = tankDepth - distance;
      if (level < 0) level = 0;
      let volume = 0;
      if (tankShape === 'rectangle') {
        let width = parseFloat('{{TANK_WIDTH}}');
        let length = parseFloat('{{TANK_LENGTH}}');
        volume = (width * length * level) / 1000; // cm³ to liters
      } else if (tankShape === 'cylinder') {
        let diameter = parseFloat('{{TANK_DIAMETER}}');
        volume = (Math.PI * Math.pow(diameter / 2, 2) * level) / 1000; // cm³ to liters
      }
      if (volumeUnit === 'gal') {
        label = (volume * 0.264172).toFixed(1) + ' gal';
      } else {
        label = volume.toFixed(1) + ' L';
      }
    } else if (configUnit === 'cm') {
      let levelCm = tankDepth - distance;
      if (levelCm < 0) levelCm = 0;
      label = levelCm.toFixed(1) + ' cm';
    } else if (configUnit === 'in') {
      let levelIn = (tankDepth - distance) / 2.54;
      if (levelIn < 0) levelIn = 0;
      label = levelIn.toFixed(1) + ' in';
    } else {
      label = percent.toFixed(1) + ' %';
    }
    if (tankShape === 'rectangle') {
      animateRectTank3D(percent);
      document.getElementById('rect-water-label').textContent = label;
    } else if (tankShape === 'cylinder') {
      animateCylTank3D(percent);
      document.getElementById('cyl-water-label').textContent = label;
    }
  });
}
setInterval(pollLevel, 1200);
window.addEventListener('DOMContentLoaded', pollLevel);
</script>
<script src="/script.js"></script>
{{FOOTER}}
</body>
</html> 